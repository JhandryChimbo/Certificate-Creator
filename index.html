<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Certificados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Incluir librerías para generar PDF y ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8 flex items-center justify-center">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-7xl w-full flex flex-col md:flex-row gap-8">
        <!-- Panel de control -->
        <div class="w-full md:w-1/2 space-y-6">
            <h1 class="text-3xl font-bold text-gray-800">Generador de Certificados</h1>
            <p class="text-gray-600">Sube tus archivos, ajusta las configuraciones y obtén una vista previa del certificado.</p>

            <!-- Zonas de arrastrar y soltar -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Zona de Excel -->
                <div id="excelDropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500 hover:border-blue-500 transition-colors duration-200 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="font-medium">Arrastra y suelta tu archivo Excel aquí</p>
                    <p class="text-sm">o haz click para subir</p>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                </div>

                <!-- Zona de Imagen de Plantilla -->
                <div id="templateDropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500 hover:border-blue-500 transition-colors duration-200 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="font-medium">Arrastra y suelta tu plantilla (JPG, PNG)</p>
                    <p class="text-sm">o haz click para subir</p>
                    <input type="file" id="templateInput" accept="image/jpeg, image/png" class="hidden">
                </div>
            </div>

            <div class="mt-4">
                <p id="excelStatus" class="text-sm text-gray-700"></p>
                <p id="templateStatus" class="text-sm text-gray-700"></p>
            </div>

            <hr class="my-6">

            <!-- Configuraciones -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800">Configuración del Certificado</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="nameColumn" class="block text-sm font-medium text-gray-700">Columna de Nombres (Excel)</label>
                        <input type="text" id="nameColumn" value="Apellidos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="nameFontSize" class="block text-sm font-medium text-gray-700">Tamaño de Fuente (Nombre)</label>
                        <input type="number" id="nameFontSize" value="90" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="nameX" class="block text-sm font-medium text-gray-700">Posición X (Nombre)</label>
                        <input type="number" id="nameX" value="570" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="nameY" class="block text-sm font-medium text-gray-700">Posición Y (Nombre)</label>
                        <input type="number" id="nameY" value="1250" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>

                <hr class="my-6">

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="numberColumn" class="block text-sm font-medium text-gray-700">Prefijo de Número (ej. 'Of. No.')</label>
                        <input type="text" id="numberColumn" value="Of. No. " class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="numberFontSize" class="block text-sm font-medium text-gray-700">Tamaño de Fuente (Número)</label>
                        <input type="number" id="numberFontSize" value="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="numberX" class="block text-sm font-medium text-gray-700">Posición X (Número)</label>
                        <input type="number" id="numberX" value="500" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="numberY" class="block text-sm font-medium text-gray-700">Posición Y (Número)</label>
                        <input type="number" id="numberY" value="1125" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>

                <div id="generationStatus" class="text-center text-sm text-gray-600 mt-4"></div>
                
                <button id="downloadButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Descargar Certificado de Ejemplo (PNG)
                </button>
                <button id="generateAllButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mt-2" disabled>
                    Generar todos los Certificados (PDFs)
                </button>
            </div>
        </div>

        <!-- Área de vista previa del certificado -->
        <div class="w-full md:w-1/2 flex items-center justify-center bg-gray-200 rounded-2xl p-4">
            <canvas id="certificateCanvas" class="w-full h-auto rounded-lg shadow-inner"></canvas>
        </div>
    </div>

    <script>
        // DOM Elements
        const excelDropZone = document.getElementById('excelDropZone');
        const excelInput = document.getElementById('excelInput');
        const templateDropZone = document.getElementById('templateDropZone');
        const templateInput = document.getElementById('templateInput');
        const excelStatus = document.getElementById('excelStatus');
        const templateStatus = document.getElementById('templateStatus');
        const certificateCanvas = document.getElementById('certificateCanvas');
        const ctx = certificateCanvas.getContext('2d');
        const nameColumnInput = document.getElementById('nameColumn');
        const nameFontSizeInput = document.getElementById('nameFontSize');
        const nameXInput = document.getElementById('nameX');
        const nameYInput = document.getElementById('nameY');
        const numberColumnInput = document.getElementById('numberColumn');
        const numberFontSizeInput = document.getElementById('numberFontSize');
        const numberXInput = document.getElementById('numberX');
        const numberYInput = document.getElementById('numberY');
        const downloadButton = document.getElementById('downloadButton');
        const generateAllButton = document.getElementById('generateAllButton');
        const generationStatus = document.getElementById('generationStatus');

        // Global variables
        let excelData = null;
        let templateImage = new Image();
        let currentName = 'Nombre de Ejemplo Apellido de Ejemplo';
        let currentNumber = 'Of. No. 001-2B-PPP-CCA-UEDL-UNL';
        let isExcelLoaded = false;
        let isImageLoaded = false;
        let isDraggingName = false;
        let isDraggingNumber = false;
        const jsPDF = window.jspdf.jsPDF;

        // Functions for Drag and Drop
        const preventDefaults = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        const highlight = (ele) => ele.classList.add('border-blue-500', 'bg-blue-50');
        const unhighlight = (ele) => ele.classList.remove('border-blue-500', 'bg-blue-50');

        const updateButtonState = () => {
            if (isExcelLoaded && isImageLoaded) {
                generateAllButton.disabled = false;
                generateAllButton.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                generateAllButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                generateAllButton.disabled = true;
                generateAllButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                generateAllButton.classList.add('bg-gray-400', 'hover:bg-gray-500');
            }
        };

        const handleDrop = (e, fileInput, statusEle) => {
            preventDefaults(e);
            unhighlight(e.target);
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files, fileInput, statusEle);
        };

        const handleFiles = (files, fileInput, statusEle) => {
            if (files.length > 0) {
                fileInput.files = files;
                statusEle.textContent = `Archivo cargado: ${files[0].name}`;
                if (fileInput.id === 'excelInput') {
                    handleExcelFile(files[0]);
                } else {
                    handleTemplateFile(files[0]);
                }
            }
        };

        const handleExcelFile = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                excelData = XLSX.utils.sheet_to_json(worksheet);
                isExcelLoaded = true;
                updateButtonState();
                if (excelData.length > 0) {
                    const nameCol = nameColumnInput.value;
                    const numberPrefix = numberColumnInput.value;
                    if (excelData[0][nameCol]) {
                        currentName = excelData[0][nameCol];
                    } else {
                        currentName = 'Nombre de Ejemplo';
                    }
                    if (excelData[0]['Codigo']) {
                        currentNumber = `Of. No. ${excelData[0]['Codigo']}-2B-PPP-CCA-UEDL-UNL`;
                    } else {
                        currentNumber = `Of. No. 001-2B-PPP-CCA-UEDL-UNL`;
                    }
                    drawCanvas();
                }
            };
            reader.readAsArrayBuffer(file);
        };

        const handleTemplateFile = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                templateImage.onload = () => {
                    isImageLoaded = true;
                    certificateCanvas.width = templateImage.width;
                    certificateCanvas.height = templateImage.height;
                    updateButtonState();
                    drawCanvas();
                };
                templateImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };
        
        // Drag and drop events setup
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            excelDropZone.addEventListener(eventName, preventDefaults, false);
            templateDropZone.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            excelDropZone.addEventListener(eventName, () => highlight(excelDropZone), false);
            templateDropZone.addEventListener(eventName, () => highlight(templateDropZone), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            excelDropZone.addEventListener(eventName, () => unhighlight(excelDropZone), false);
            templateDropZone.addEventListener(eventName, () => unhighlight(templateDropZone), false);
        });

        excelDropZone.addEventListener('drop', e => handleDrop(e, excelInput, excelStatus), false);
        templateDropZone.addEventListener('drop', e => handleDrop(e, templateInput, templateStatus), false);

        excelInput.addEventListener('change', (e) => handleFiles(e.target.files, excelInput, excelStatus));
        templateInput.addEventListener('change', (e) => handleFiles(e.target.files, templateInput, templateStatus));

        excelDropZone.addEventListener('click', () => excelInput.click());
        templateDropZone.addEventListener('click', () => templateInput.click());

        // Draw on canvas
        const drawCanvas = () => {
            if (!isImageLoaded) return;
            
            // Clear and draw template image
            ctx.clearRect(0, 0, certificateCanvas.width, certificateCanvas.height);
            ctx.drawImage(templateImage, 0, 0);

            // Get settings from inputs
            const nameFontSize = parseInt(nameFontSizeInput.value, 10);
            const nameX = parseInt(nameXInput.value, 10);
            const nameY = parseInt(nameYInput.value, 10);
            const numberFontSize = parseInt(numberFontSizeInput.value, 10);
            const numberX = parseInt(numberXInput.value, 10);
            const numberY = parseInt(numberYInput.value, 10);

            // Draw name
            ctx.font = `${nameFontSize}px Arial`;
            ctx.fillStyle = 'black';
            ctx.textAlign = 'left';
            ctx.fillText(currentName, nameX, nameY);

            // Draw certificate number
            ctx.font = `${numberFontSize}px Arial`;
            ctx.fillStyle = 'black';
            ctx.textAlign = 'left';
            ctx.fillText(currentNumber, numberX, numberY);
        };

        // Update canvas on input change
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', drawCanvas);
        });

        // Dragging text on canvas
        const getMousePos = (canvas, evt) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        };

        certificateCanvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(certificateCanvas, e);
            const nameX = parseInt(nameXInput.value, 10);
            const nameY = parseInt(nameYInput.value, 10);
            const numberX = parseInt(numberXInput.value, 10);
            const numberY = parseInt(numberYInput.value, 10);
            const nameFontSize = parseInt(nameFontSizeInput.value, 10);
            const numberFontSize = parseInt(numberFontSizeInput.value, 10);
            
            // Simple hit-test for name
            ctx.font = `${nameFontSize}px Arial`;
            const nameMetrics = ctx.measureText(currentName);
            const nameWidth = nameMetrics.width;
            const nameHeight = nameFontSize;
            if (pos.x >= nameX && pos.x <= nameX + nameWidth && pos.y >= nameY - nameHeight && pos.y <= nameY) {
                isDraggingName = true;
            }

            // Simple hit-test for number
            ctx.font = `${numberFontSize}px Arial`;
            const numberMetrics = ctx.measureText(currentNumber);
            const numberWidth = numberMetrics.width;
            const numberHeight = numberFontSize;
            if (pos.x >= numberX && pos.x <= numberX + numberWidth && pos.y >= numberY - numberHeight && pos.y <= numberY) {
                isDraggingNumber = true;
            }
        });

        certificateCanvas.addEventListener('mousemove', (e) => {
            if (!isDraggingName && !isDraggingNumber) return;
            const pos = getMousePos(certificateCanvas, e);
            if (isDraggingName) {
                nameXInput.value = Math.floor(pos.x);
                nameYInput.value = Math.floor(pos.y);
            }
            if (isDraggingNumber) {
                numberXInput.value = Math.floor(pos.x);
                numberYInput.value = Math.floor(pos.y);
            }
            drawCanvas();
        });

        certificateCanvas.addEventListener('mouseup', () => {
            isDraggingName = false;
            isDraggingNumber = false;
        });

        // Download single PNG button functionality
        downloadButton.addEventListener('click', () => {
            if (!isImageLoaded) {
                // Using a custom alert instead of window.alert()
                alert('Por favor, carga una plantilla de certificado primero.');
                return;
            }
            // Create a new canvas to ensure it's not a live version
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = certificateCanvas.width;
            finalCanvas.height = certificateCanvas.height;
            const finalCtx = finalCanvas.getContext('2d');
            
            // Draw all elements on the new canvas
            finalCtx.drawImage(templateImage, 0, 0);
            
            const nameFontSize = parseInt(nameFontSizeInput.value, 10);
            const nameX = parseInt(nameXInput.value, 10);
            const nameY = parseInt(nameYInput.value, 10);
            const numberFontSize = parseInt(numberFontSizeInput.value, 10);
            const numberX = parseInt(numberXInput.value, 10);
            const numberY = parseInt(numberYInput.value, 10);
            
            finalCtx.font = `${nameFontSize}px Arial`;
            finalCtx.fillStyle = 'black';
            finalCtx.textAlign = 'left';
            finalCtx.fillText(currentName, nameX, nameY);

            finalCtx.font = `${numberFontSize}px Arial`;
            finalCtx.fillStyle = 'black';
            finalCtx.textAlign = 'left';
            finalCtx.fillText(currentNumber, numberX, numberY);

            // Trigger download
            const link = document.createElement('a');
            link.download = 'certificado-ejemplo.png';
            link.href = finalCanvas.toDataURL('image/png');
            link.click();
        });

        // Generate all PDFs and ZIP button functionality
        generateAllButton.addEventListener('click', async () => {
            if (!isExcelLoaded || !isImageLoaded) {
                generationStatus.textContent = 'Por favor, carga tanto el archivo Excel como la plantilla de imagen.';
                return;
            }
            
            generationStatus.textContent = 'Generando certificados... por favor espera.';
            generateAllButton.disabled = true;

            const zip = new JSZip();
            const imgWidth = templateImage.width;
            const imgHeight = templateImage.height;

            const nameCol = nameColumnInput.value;
            const numberPrefix = numberColumnInput.value;
            
            for (let i = 0; i < excelData.length; i++) {
                const row = excelData[i];
                const fullName = row[nameCol] || `Nombre No. ${i + 1}`;
                const certificateNumber = row['Codigo'] ? `${numberPrefix}${row['Codigo']}` : `${numberPrefix}${String(i + 1).padStart(3, '0')}-2B-PPP-CCA-UEDL-UNL`;

                generationStatus.textContent = `Generando certificado para ${fullName} (${i + 1}/${excelData.length})...`;

                const doc = new jsPDF({
                    orientation: imgWidth > imgHeight ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [imgWidth, imgHeight]
                });

                // Add the image to the PDF
                doc.addImage(templateImage.src, 'JPEG', 0, 0, imgWidth, imgHeight);

                // Add text to the PDF
                const nameFontSize = parseInt(nameFontSizeInput.value, 10);
                const nameX = parseInt(nameXInput.value, 10);
                const nameY = parseInt(nameYInput.value, 10);
                const numberFontSize = parseInt(numberFontSizeInput.value, 10);
                const numberX = parseInt(numberXInput.value, 10);
                const numberY = parseInt(numberYInput.value, 10);

                doc.setFontSize(nameFontSize);
                doc.text(fullName, nameX, nameY);

                doc.setFontSize(numberFontSize);
                doc.text(certificateNumber, numberX, numberY);
                
                const pdfBlob = doc.output('blob');
                zip.file(`${fullName}.pdf`, pdfBlob);

                // Simulate a delay for a smoother progress display
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            generationStatus.textContent = 'Comprimiendo certificados en un archivo ZIP...';
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                const link = document.createElement('a');
                link.download = 'certificados.zip';
                link.href = URL.createObjectURL(content);
                link.click();
                generationStatus.textContent = '¡Todos los certificados han sido generados y descargados con éxito!';
                updateButtonState();
            });
        });

        // Initial state
        drawCanvas();
        updateButtonState();

    </script>

</body>
</html>
